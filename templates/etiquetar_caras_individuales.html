<!-- Etiquetar Caras Individuales -->
<div class="container-fluid" style="margin-top: 70px; padding: 2rem;">
  
  <!-- Header -->
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="mb-1 text-white">
          <i class="fas fa-user-tag text-primary me-2"></i>
          Identificar Personas
        </h2>
        <p class="text-muted mb-0">
          {% if caras %}
            Encontramos {{ caras|length }} cara{{ 's' if caras|length != 1 else '' }} para identificar
          {% else %}
            No se detectaron caras en las fotos
          {% endif %}
        </p>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-success" onclick="guardarIdentificaciones()">
          <i class="fas fa-save me-2"></i>Guardar Identificaciones
        </button>
        <button class="btn btn-outline-secondary"
                hx-get="/ver-todas-fotos"
                hx-target="#panel-content"
                hx-swap="innerHTML">
          <i class="fas fa-skip-forward me-2"></i>Omitir
        </button>
      </div>
    </div>
  </div>

  {% if caras %}
    <!-- Grid de caras individuales -->
    <div class="row g-4">
      {% for cara in caras %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2">
          <div class="card h-100 shadow-sm">
            <!-- Imagen de la cara (200x200) -->
            <div class="position-relative" style="height: 200px; overflow: hidden;">
              <img src="{{ cara.recorte_url }}" 
                   alt="Cara detectada"
                   class="card-img-top w-100 h-100"
                   style="object-fit: cover;"
                   loading="lazy">
              
              <!-- Badge con info de la foto original -->
              <div class="position-absolute top-0 end-0 m-2">
                <span class="badge bg-dark bg-opacity-75 small">
                  {{ cara.foto_nombre[:15] }}{{ '...' if cara.foto_nombre|length > 15 else '' }}
                </span>
              </div>
            </div>
            
            <!-- Input para el nombre -->
            <div class="card-body p-3">
              <div class="mb-2">
                <label class="form-label small text-muted mb-1">
                  <i class="fas fa-user me-1"></i>¿Quién es esta persona?
                </label>
                <input type="text" 
                       class="form-control form-control-sm" 
                       placeholder="Escribe el nombre..."
                       data-cara-id="{{ cara.cara_id }}"
                       data-foto-id="{{ cara.foto_id }}"
                       data-cara-index="{{ cara.cara_index }}"
                       data-face-token="{{ cara.face_token }}"
                       data-recorte-url="{{ cara.recorte_url }}"
                       data-recorte-public-id="{{ cara.recorte_public_id }}">
              </div>
              
              <!-- Botones de sugerencia rápida -->
              <div class="d-flex gap-1 flex-wrap">
                <button class="btn btn-outline-primary btn-xs" 
                        onclick="sugerirNombre('{{ cara.cara_id }}', 'Familia')">
                  Familia
                </button>
                <button class="btn btn-outline-info btn-xs" 
                        onclick="sugerirNombre('{{ cara.cara_id }}', 'Amigo')">
                  Amigo
                </button>
                <button class="btn btn-outline-warning btn-xs" 
                        onclick="marcarComoDesconocido('{{ cara.cara_id }}')">
                  <i class="fas fa-question"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    
    <!-- Botón flotante para guardar -->
    <div class="position-fixed bottom-0 end-0 p-4">
      <button class="btn btn-success btn-lg rounded-circle shadow" 
              onclick="guardarIdentificaciones()"
              title="Guardar identificaciones">
        <i class="fas fa-save"></i>
      </button>
    </div>
    
  {% else %}
    <!-- Estado vacío -->
    <div class="text-center py-5">
      <i class="fas fa-user-slash fa-4x text-muted mb-3"></i>
      <h4 class="text-white">No se detectaron caras</h4>
      <p class="text-muted mb-4">No encontramos caras para identificar en las fotos subidas</p>
      <button class="btn btn-primary"
              hx-get="/ver-todas-fotos"
              hx-target="#panel-content"
              hx-swap="innerHTML">
        <i class="fas fa-images me-2"></i>Ver Galería
      </button>
    </div>
  {% endif %}
</div>

<script>
// Función para sugerir nombre
function sugerirNombre(caraId, nombre) {
  const input = document.querySelector(`input[data-cara-id="${caraId}"]`);
  if (input) {
    input.value = nombre;
    input.focus();
  }
}

// Función para marcar como desconocido
function marcarComoDesconocido(caraId) {
  const input = document.querySelector(`input[data-cara-id="${caraId}"]`);
  if (input) {
    input.value = '';
    input.placeholder = 'Persona desconocida (se omitirá)';
    input.style.opacity = '0.6';
  }
}

// Función para guardar todas las identificaciones
async function guardarIdentificaciones() {
  const identificaciones = [];
  
  // Recopilar datos de todas las caras con nombre
  document.querySelectorAll('input[data-cara-id]').forEach(input => {
    const nombre = input.value.trim();
    if (nombre && nombre !== '') {
      identificaciones.push({
        cara_id: input.dataset.caraId,
        foto_id: parseInt(input.dataset.fotoId),
        cara_index: parseInt(input.dataset.caraIndex),
        face_token: input.dataset.faceToken,
        recorte_url: input.dataset.recorteUrl,
        recorte_public_id: input.dataset.recortePublicId,
        nombre: nombre
      });
    }
  });
  
  console.log('Identificaciones a guardar:', identificaciones);
  
  if (identificaciones.length === 0) {
    alert('No hay identificaciones para guardar. Escribe al menos un nombre.');
    return;
  }
  
  try {
    // Mostrar loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
    btn.disabled = true;
    
    const response = await fetch('/api/guardar-identificaciones-caras', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ identificaciones: identificaciones })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Mostrar éxito y redirigir
      btn.innerHTML = '<i class="fas fa-check me-2"></i>¡Guardado!';
      btn.className = 'btn btn-success';
      
      setTimeout(() => {
        htmx.ajax('GET', '/ver-todas-fotos', {target: '#panel-content', swap: 'innerHTML'});
      }, 1500);
    } else {
      throw new Error(result.message || 'Error guardando identificaciones');
    }
    
  } catch (error) {
    console.error('Error:', error);
    alert('Error guardando las identificaciones: ' + error.message);
    
    // Restaurar botón
    btn.innerHTML = originalText;
    btn.disabled = false;
    btn.className = 'btn btn-success';
  }
}
</script>

<style>
.btn-xs {
  padding: 0.125rem 0.25rem;
  font-size: 0.75rem;
  line-height: 1.2;
}

.card-img-top {
  border-radius: 0.375rem 0.375rem 0 0;
}

input:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.position-fixed.bottom-0.end-0 {
  z-index: 1000;
}
</style>