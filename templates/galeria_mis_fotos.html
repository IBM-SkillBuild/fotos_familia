    <link
      href="{{ url_for('static', filename='css/dark-theme-fixes.css') }}"
      rel="stylesheet"
    />

<!-- Galería de Mis Fotos -->
<div id="mis-fotos-container" class="container-fluid" style=" padding: 2rem;">
  
  <!-- Header con controles -->
  <div class="mb-4">
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center mb-3 gallery-header">
      <div class="d-flex flex-column flex-sm-row align-items-center gap-2 left-section">
        <h2 class="mb-1 text-white" style="padding-right: 2em;">
          <i class="fas fa-user-images text-info me-2"></i>
          Mis Fotos
        </h2>
        <div class="d-flex flex-column flex-sm-row align-items-center gap-2">
          <select name="buscar_persona" class="custom-select" style="height: 35px; border-radius: 5px;"
                  hx-get="{% if is_my_photos %}/api/buscar-mis-fotos-persona{% else %}/api/buscar-mis-fotos-persona{% endif %}"
                  hx-trigger="change"
                  hx-target="#panel-content"
                  hx-swap="innerHTML"
                  hx-indicator="#search-spinner">
            <option value="">Categorías</option>
            <option value="familia">familia completa o varios</option>
            <option value="hermanos">hermanos</option>
            <option value="boda">bodas</option>
            <option value="antigua">antigua</option>
            <option value="vacaciones">vacaciones</option>
            <option value="fake">fake</option>
            <option value="amigos">amigos</option>
            <option value="retrato">retratos-selfie</option>
            <option value="cumpleaños">cumpleaños</option>
          </select>

          <div id="search-spinner" class="htmx-indicator ms-2" style="display: none;">
            <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
          </div>
        </div>
        <p class="text-muted mb-0" style="padding-left: 2em;">
          {% if fotos %}
            <span id="totalPhotos" style="color:white">{{ fotos|length }} foto{{ 's' if fotos|length != 1 else '' }} subida{{ 's' if fotos|length != 1 else '' }} por ti </span>
          {% else %}
            No has subido fotos aún
          {% endif %}
        </p>
      </div>
      <div class="right-section">
        <button class="btn btn-outline-secondary"
                hx-get="/selector_fotos"
                hx-target="#panel-content"
                hx-swap="innerHTML"
                style="cursor: pointer;">
          <i class="fas fa-arrow-left me-2"></i>Volver
        </button>
                  <button class="btn btn-info" style="height: 35px; border-radius: 5px;margin-left: 8px;"
                 hx-get="/gestionar-personas"
                hx-target="#panel-content"
                hx-swap="innerHTML"
            Personas
          </button>
      </div>
    </div>
  </div>

  {% if fotos %}
    <div id="fotos-grid" class="row g-3">
      {% for foto in fotos %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2"
             id="photo-card-{{ foto.id }}"
             data-photo-id="{{ foto.id }}"
             data-personas="{{ (foto.personas_nombres | join(', ')) if foto.personas_nombres else '' }}"
             data-foto-nombre="{{ foto.nombre }}">
          <div class="card h-100 shadow-sm">
            <div class="position-relative" style="height: 200px; overflow: hidden;">
              <img src="{{ foto.nombre_archivo }}" 
                   alt="{{ foto.nombre }}"
                   class="card-img-top w-100 h-100"
                   style="object-fit: cover; cursor: pointer;"
                   onclick="openPhotoModal(
                     '{{ foto.nombre_archivo }}',
                     '{{ foto.nombre }}',
                     '{{ foto.usuario_nombre }}',
                     '{{ foto.mes }}/{{ foto.año }}',
                     'photo-card-{{ foto.id }}'
                   )"
                   loading="lazy">
              
              <div class="position-absolute top-0 end-0 m-2 d-flex align-items-center gap-1">
                <span class="badge bg-dark bg-opacity-75">
                  {{ foto.mes }}/{{ foto.año }}
                </span>
                <input type="checkbox" 
                       class="form-check-input" 
                       data-photo-id="{{ foto.id }}"
                       data-photo-user="{{ foto.usuario_nombre }}"
                       data-current-user="{{ user.name }}"
                       style="cursor: pointer; transform: scale(1.1); margin: 0; vertical-align: middle;">
              </div>
            </div>
            
            <div class="card-body p-2">
              <h6 class="card-title mb-1 text-truncate" title="{{ foto.nombre }}">
                {{ foto.nombre }}
              </h6>
              <small class="text-muted">
                <i class="fas fa-user me-1"></i>{{ foto.usuario_nombre }}
              </small>
              <button class="btn btn-outline-secondary btn-sm w-100" 
                      hx-get="/editar_nombre?id={{ foto.id }}"
                      hx-target="#panel-content"
                      hx-swap="innerHTML">
                <i class="fas fa-tag me-1"></i>Editar Nombre
              </button>
              
              {% if foto.necesita_etiquetado %}
                <div class="mt-2">
                  <button class="btn btn-warning btn-sm w-100" 
                          onclick="etiquetarFoto({{ foto.id }})">
                    <i class="fas fa-tag me-1"></i>Etiquetar
                  </button>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-5">
      <i class="fas fa-user-images fa-4x text-muted mb-3"></i>
      <h4 class="text-muted">No has subido fotos aún</h4>
      <p class="text-muted mb-4">Sube tu primera foto a la galería familiar</p>
      <button class="btn btn-success"
              hx-get="/subir_foto"
              hx-target="#panel-content"
              hx-swap="innerHTML">
        <i class="fas fa-plus me-2"></i>Subir Primera Foto
      </button>
    </div>
  {% endif %}
</div>



<!-- Estilos del modal y layout móvil -->
<style>
  .fixed-top-controls {
    position: fixed;
    top: 56px; /* Height of the navbar */
    left: 0;
    right: 0;
    z-index: 1000;
    background-color: #fff !important; /* Fondo completamente opaco */
    padding: 0.5rem 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    opacity: 1 !important; /* Opacidad completa, forzada - INICIAL SIEMPRE 1 */
  }
  .navbar.navbar-expand-lg.navbar-dark.bg-dark.fixed-top {
    background-color: #212529 !important; /* Fondo opaco del navbar (bg-dark de Bootstrap) */
    opacity: 1 !important; /* Opacidad completa, forzada - INICIAL SIEMPRE 1 */
  }


  /* Ajustes para móviles */
  @media (max-width: 576px) {
    .gallery-header {
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 0.5rem !important;
    }
    .gallery-header .left-section,
    .gallery-header .right-section {
      width: 100%;
      justify-content: flex-start;
    }
    .gallery-header h2 {
      font-size: 1.5rem; /* Reducir tamaño del título */
      margin-bottom: 0.5rem;
    }
    .gallery-header select.form-select {
      width: 100%; /* Dropdown ocupa todo el ancho */
      max-width: none;
    }
    .gallery-header p.text-muted {
      font-size: 0.9rem; /* Reducir tamaño del contador */
      margin-bottom: 0.5rem;
    }
    .gallery-header .btn {
      width: auto; /* Botón "Volver" no ocupa todo el ancho */
    }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Función para forzar el colapso del menú hamburguesa
  function collapseMobileNav() {
    const mobileNav = document.getElementById('mobileNav');
    if (mobileNav && mobileNav.classList.contains('show')) {
      console.log('Colapsando mobileNav');
      const collapseInstance = bootstrap.Collapse.getInstance(mobileNav) || new bootstrap.Collapse(mobileNav, { toggle: false });
      collapseInstance.hide();
    } else {
      console.log('mobileNav no encontrado o no visible:', mobileNav);
    }
  }

  // Cerrar el menú al iniciar una solicitud HTMX desde los enlaces
  document.addEventListener("htmx:beforeRequest", function (event) {
    const triggerElement = event.detail.elt;
    if (triggerElement.closest('#mobileNav')) {
      console.log('htmx:beforeRequest desde mobileNav');
      collapseMobileNav();
    }
  });

  // Añadir listener de click a los links del menú móvil para cerrar al click
  document.addEventListener('DOMContentLoaded', function () {
    const mobileNavLinks = document.querySelectorAll('#mobileNav .nav-link');
    mobileNavLinks.forEach(link => {
      link.addEventListener('click', () => {
        console.log('Clic en nav-link:', link.textContent);
        collapseMobileNav();
      });
    });
  });

  // Re-inicializar Bootstrap collapse después de HTMX settle
  document.addEventListener("htmx:afterSettle", function (event) {
    console.log('htmx:afterSettle disparado');
    const collapses = document.querySelectorAll('[data-bs-toggle="collapse"]');
    collapses.forEach((el) => {
      if (!bootstrap.Collapse.getInstance(el)) {
        console.log('Reinicializando collapse para:', el);
        new bootstrap.Collapse(el, { toggle: false });
      }
    });
  });

  // Re-inicializar en onLoad para contenido nuevo
  htmx.onLoad(function (content) {
    console.log('htmx:onLoad disparado');
    const collapses = content.querySelectorAll('[data-bs-toggle="collapse"]');
    collapses.forEach((el) => {
      if (!bootstrap.Collapse.getInstance(el)) {
        console.log('Reinicializando collapse en onLoad para:', el);
        new bootstrap.Collapse(el, { toggle: false });
      }
    });
  });

  // Las funciones del modal ahora están en index.html como funciones globales

  // Placeholder functions for buttons
  function filterByDate() {
    console.log("Filtrar por fecha");
  }
  function filterByPerson() {
    console.log("Filtrar por persona");
  }
  function deleteSelected() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"][data-photo-id]:checked');
    if (checkboxes.length === 0) {
      alert('Selecciona al menos una foto para eliminar');
      return;
    }

    const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.photoId);
    
    if (confirm(`¿Borrar ${selectedIds.length} foto${selectedIds.length !== 1 ? 's' : ''}?`)) {
      borrarMisFotos(selectedIds);
    }
  }

  async function borrarMisFotos(ids) {
    try {
      const res = await fetch('/api/borrar-fotos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ foto_ids: ids })
      });
      
      const data = await res.json();
      if (data.success) {
        alert(`${data.deleted_count} foto${data.deleted_count !== 1 ? 's' : ''} eliminada${data.deleted_count !== 1 ? 's' : ''} correctamente`);
        // Recargar mis fotos
        htmx.ajax('GET', '/ver-mis-fotos', { target: '#panel-content', swap: 'innerHTML' });
      } else {
        alert(data.message || 'Error al eliminar las fotos');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al eliminar las fotos');
    }
  }
    function etiquetarFoto(fotoId) {
    // Redirigir al procesamiento de reconocimiento facial para esta foto específica
    htmx.ajax('GET', `/api/procesar-reconocimiento-facial?ids=${fotoId}`, {
      target: '#panel-content',
      swap: 'innerHTML'
    });
  }
  // Los event listeners del modal ahora están en index.html

  // Función para descargar la foto
  function downloadPhoto(src, title) {
    const modal = new bootstrap.Modal(document.getElementById('downloadModal'));
    const progressBar = document.getElementById('downloadProgressBar');
    modal.show();

    // Simular progreso de descarga
    let progress = 0;
    const interval = setInterval(() => {
      progress += 10;
      progressBar.style.width = `${progress}%`;
      progressBar.textContent = `${progress}%`;
      progressBar.setAttribute('aria-valuenow', progress);
      if (progress >= 100) {
        clearInterval(interval);
        setTimeout(() => {
          modal.hide();
          const link = document.createElement('a');
          link.href = src;
          link.download = title || 'photo.jpg';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          progressBar.style.width = '0%';
          progressBar.textContent = '0%';
          progressBar.setAttribute('aria-valuenow', 0);
        }, 500);
      }
    }, 200);
  }
</script>

<!-- Modal de Descarga con Barra de Progreso -->
<div id="downloadModal" class="modal fade" tabindex="-1" aria-labelledby="downloadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="downloadModalLabel">Descargando Foto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Por favor, espera mientras se descarga la foto.</p>
        <div class="progress">
          <div id="downloadProgressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
      </div>
    </div>
  </div>
</div>
