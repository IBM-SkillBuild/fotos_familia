    <link
      href="{{ url_for('static', filename='css/dark-theme-fixes.css') }}"
      rel="stylesheet"
    />
{% extends "base.html" %} {% block title %}Dashboard - {{ user.name }}{%
endblock %} {% block content %}
<div id="main-content">
  <div class="container mt-4">
    <div class="row">
      <div class="col-md-10 mx-auto">
        <div class="card user-info-card">
          <div
            class="card-header dashboard-header d-flex justify-content-between align-items-center"
          >
            <h4 class="mb-0">¬°Bienvenido, {{ user.name }}!</h4>
            <button class="btn logout-btn" onclick="logout()">
              Cerrar Sesi√≥n
            </button>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h5>Informaci√≥n de Usuario</h5>
                <table class="table table-borderless info-table">
                  <tr>
                    <td><strong>Nombre:</strong></td>
                    <td>{{ user.name }}</td>
                  </tr>
                  {% if user.email %}
                  <tr>
                    <td><strong>Email:</strong></td>
                    <td>{{ user.email }}</td>
                  </tr>
                  {% endif %} {% if user.phone %}
                  <tr>
                    <td><strong>Tel√©fono:</strong></td>
                    <td>{{ user.phone }}</td>
                  </tr>
                  {% endif %}
                  <tr>
                    <td><strong>Registrado:</strong></td>
                    <td>{{ user.created_at[:19] }}</td>
                  </tr>
                </table>
              </div>
              <div class="col-md-6">
                <h5>Estado de Sesi√≥n</h5>
                <div class="status-badge text-center mb-3">
                  ‚úì Autenticado correctamente
                </div>

                <div class="session-info">
                  <div class="mb-2">
                    <strong>Sesi√≥n expira:</strong><br />
                    <span class="text-primary"
                      >{{ session_info.expires_at }}</span
                    >
                  </div>

                  <div class="mb-2">
                    <strong>Tiempo restante:</strong><br />
                    {% include 'session_status.html' %}
                  </div>
                </div>
              </div>
            </div>

            <hr />

            <div class="row mt-4">
              <div class="col-12">
                <h5>Panel de Control</h5>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                      <div class="card-body text-center">
                        <div class="mb-2">üë§</div>
                        <h6>Perfil</h6>
                        <p class="text-muted small">Gestiona tu informaci√≥n</p>
                        <button
                          class="btn btn-outline-primary btn-sm"
                          hx-get="/profile-content"
                          hx-target="#main-content"
                          hx-swap="innerHTML"
                        >
                          Ver Perfil
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                      <div class="card-body text-center">
                        <div class="mb-2">üîí</div>
                        <h6>Seguridad</h6>
                        <p class="text-muted small">
                          Configuraci√≥n de seguridad
                        </p>
                        <button class="btn btn-outline-primary btn-sm" disabled>
                          Pr√≥ximamente
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                      <div class="card-body text-center">
                        <div class="mb-2">üìä</div>
                        <h6>Historial</h6>
                        <p class="text-muted small">Actividad reciente</p>
                        <button class="btn btn-outline-primary btn-sm" disabled>
                          Pr√≥ximamente
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de confirmaci√≥n de logout -->
    <div class="modal fade" id="logoutModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmar Cierre de Sesi√≥n</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            ¬øEst√°s seguro de que quieres cerrar sesi√≥n?
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="confirmLogout()"
            >
              Cerrar Sesi√≥n
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>

  function logout() {
    const modal = new bootstrap.Modal(document.getElementById("logoutModal"));
    modal.show();
  }

  async function confirmLogout() {
    try {
      // Mostrar indicador de carga
      const button = event.target;
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = "Cerrando...";

      const response = await fetch("/logout", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      });

      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          window.location.href = data.redirect || "/";
        } else {
          throw new Error("Logout failed");
        }
      } else {
        throw new Error(`HTTP ${response.status}`);
      }
    } catch (error) {
      console.error("Error al cerrar sesi√≥n:", error);
      // En caso de error, tambi√©n redirigir
      window.location.href = "/";
    }
  }

  // HTMX se encarga de actualizar la sesi√≥n autom√°ticamente cada minuto
  // Solo mantenemos una verificaci√≥n de respaldo cada 5 minutos
  setInterval(async () => {
    try {
      const response = await fetch("/api/session-info");
      if (!response.ok) {
        // Sesi√≥n expirada o error
        alert("Tu sesi√≥n ha expirado. Ser√°s redirigido al login.");
        window.location.href = "/";
      }
    } catch (error) {
      console.error("Error verificando sesi√≥n:", error);
    }
  }, 300000); // 5 minutos
</script>
{% endblock %}
